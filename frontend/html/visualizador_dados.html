<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>PLI 2050 - Visualizador de Dados</title>
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
    <link rel="stylesheet" href="../css/index.css?v=20251107">
    <link rel="stylesheet" href="../css/pages.css?v=20251107">
    <style>
        /* Estilos espec√≠ficos do visualizador */
        .info-box {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .info-box h2 {
            color: #3498db;
            margin-top: 0;
        }
        .status {
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .data-viewer {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }
        button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        button:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #ffeeba;
            margin: 1rem 0;
        }
        #loading-status {
            display: none;
            padding: 1rem;
            background: #d1ecf1;
            border-radius: 4px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navega√ß√£o -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>PLI 2050 - SP</h1>
                <p>Plano de Log√≠stica e Investimentos</p>
            </div>
            <div class="nav-menu">
                <button class="nav-btn" onclick="navegarPara('formulario')">
                    <span>ÔøΩ</span> Formul√°rio
                </button>
                <button class="nav-btn" onclick="navegarPara('respostas')">
                    <span>üìä</span> Respostas
                </button>
                <button class="nav-btn" onclick="navegarPara('analytics')">
                    <span>üìà</span> Analytics
                </button>
                <button class="nav-btn" onclick="navegarPara('instrucoes')">
                    <span>üìñ</span> Instru√ß√µes
                </button>
                <button class="nav-btn active" onclick="navegarPara('visualizador')">
                    <span>ÔøΩüîç</span> Visualizador
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>üîç Visualizador de Dados - AWS RDS</h2>
            <p>Visualize os dados armazenados no banco PostgreSQL (AWS RDS)</p>
        </div>
    
    <div class="info-box">
        <h2>üìä Informa√ß√µes do Banco de Dados</h2>
        <div class="status info">
            <strong>üóÑÔ∏è Banco:</strong> PostgreSQL 17<br>
            <strong>‚òÅÔ∏è Hospedagem:</strong> AWS RDS (us-east-1)<br>
            <strong>üì¶ Database:</strong> sigma_pli<br>
            <strong>üîç Schema:</strong> formulario_embarcadores<br>
            <strong>üìã View Principal:</strong> v_pesquisas_completa (65 campos)<br>
            <strong>üåê API:</strong> <span id="api-url"></span>
        </div>
    </div>

    <div class="info-box">
        <h2>üíæ Dados da View v_pesquisas_completa</h2>
        <button onclick="loadDataFromRDS()">üîÑ Carregar Dados do RDS</button>
        <button onclick="showRawDataRDS()">üìÑ Ver JSON Completo</button>
        <button onclick="exportToCSV()">ÔøΩ Exportar CSV</button>
        <div id="loading-status" style="display: none; padding: 1rem; background: #d1ecf1; border-radius: 4px; margin-top: 1rem;">
            <strong>‚è≥ Carregando dados do RDS...</strong>
        </div>
        <div id="data-container"></div>
    </div>

    <div class="info-box">
        <h2>üõ†Ô∏è Ferramentas de Desenvolvedor</h2>
        <div class="warning">
            <strong>üí° Dica:</strong> Para ver as requisi√ß√µes de rede:<br>
            1. Pressione <kbd>F12</kbd> para abrir DevTools<br>
            2. V√° na aba <strong>"Network"</strong><br>
            3. Clique em <strong>"Carregar Dados do RDS"</strong><br>
            4. Veja a requisi√ß√£o para <code>/api/pesquisas/listar</code>
        </div>
    </div>
    
    </div> <!-- Fecha container -->

    <script>
        // Carregar core-api para fazer requisi√ß√µes
        const script = document.createElement('script');
        script.src = '../js/core-api.js?v=20251109';
        document.head.appendChild(script);

        // Mostrar URL da API
        script.onload = function() {
            document.getElementById('api-url').textContent = window.CoreAPI.BASE_URL;
        };

        // Carregar dados do RDS via API
        async function loadDataFromRDS() {
            const container = document.getElementById('data-container');
            const loadingStatus = document.getElementById('loading-status');
            
            try {
                loadingStatus.style.display = 'block';
                container.innerHTML = '';
                
                console.log('üì° Buscando dados do RDS...');
                const response = await window.CoreAPI.get('/api/pesquisas/listar?limit=1000');
                
                loadingStatus.style.display = 'none';
                
                if (!response.pesquisas || response.pesquisas.length === 0) {
                    container.innerHTML = `
                        <div class="status info">
                            üì≠ Nenhuma pesquisa encontrada no banco RDS.<br>
                            V√° para a p√°gina de Formul√°rio e envie uma pesquisa!
                        </div>
                    `;
                    return;
                }
                
                const pesquisas = response.pesquisas;
                
                let html = `
                    <div class="status success">
                        ‚úÖ <strong>${pesquisas.length}</strong> pesquisa(s) encontrada(s) no RDS!
                    </div>
                    <h3>Resumo das Pesquisas:</h3>
                `;
                
                pesquisas.forEach((p, i) => {
                    html += `
                        <div style="background: #ecf0f1; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                            <strong>Pesquisa ${i + 1}:</strong><br>
                            <strong>ID:</strong> ${p.id_pesquisa}<br>
                            <strong>Empresa:</strong> ${p.razao_social || p.nome_empresa}<br>
                            <strong>CNPJ:</strong> ${p.cnpj || 'N/A'}<br>
                            <strong>Entrevistado:</strong> ${p.nome_entrevistado}<br>
                            <strong>Fun√ß√£o:</strong> ${p.funcao_entrevistado}<br>
                            <strong>Data:</strong> ${p.data_entrevista || 'N/A'}<br>
                            <strong>Produto Principal:</strong> ${p.produto_principal}<br>
                            <strong>Tipo Transporte:</strong> ${p.tipo_transporte}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                console.log('‚úÖ Dados carregados:', pesquisas.length);
                
            } catch (error) {
                loadingStatus.style.display = 'none';
                console.error('‚ùå Erro ao carregar dados:', error);
                container.innerHTML = `
                    <div class="status warning">
                        ‚ùå Erro ao conectar ao RDS:<br>
                        <strong>Mensagem:</strong> ${error.message || 'Erro desconhecido'}<br><br>
                        <strong>Poss√≠veis causas:</strong><br>
                        ‚Ä¢ Backend n√£o est√° rodando no Render<br>
                        ‚Ä¢ Problema de conex√£o com AWS RDS<br>
                        ‚Ä¢ CORS bloqueando requisi√ß√£o<br><br>
                        <strong>URL da API:</strong> ${window.CoreAPI?.BASE_URL || 'N/A'}
                    </div>
                `;
            }
        }

        // Mostrar JSON completo
        async function showRawDataRDS() {
            const container = document.getElementById('data-container');
            const loadingStatus = document.getElementById('loading-status');
            
            try {
                loadingStatus.style.display = 'block';
                const response = await window.CoreAPI.get('/api/pesquisas/listar?limit=1000');
                loadingStatus.style.display = 'none';
                
                const json = JSON.stringify(response, null, 2);
                
                container.innerHTML = `
                    <h3>JSON Completo (View v_pesquisas_completa):</h3>
                    <div class="data-viewer">${json}</div>
                `;
                
            } catch (error) {
                loadingStatus.style.display = 'none';
                container.innerHTML = `<div class="status warning">‚ùå Erro: ${error.message}</div>`;
            }
        }

        // Exportar para CSV
        async function exportToCSV() {
            try {
                const response = await window.CoreAPI.get('/api/pesquisas/listar?limit=1000');
                
                if (!response.pesquisas || response.pesquisas.length === 0) {
                    alert('üì≠ Nenhuma pesquisa para exportar');
                    return;
                }
                
                const pesquisas = response.pesquisas;
                
                // Pegar todas as colunas (keys do primeiro objeto)
                const headers = Object.keys(pesquisas[0]);
                
                // Criar CSV
                let csv = headers.join(',') + '\n';
                
                pesquisas.forEach(p => {
                    const row = headers.map(header => {
                        let value = p[header];
                        // Escapar v√≠rgulas e aspas
                        if (value && typeof value === 'string') {
                            value = value.replace(/"/g, '""');
                            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                                value = `"${value}"`;
                            }
                        }
                        return value || '';
                    });
                    csv += row.join(',') + '\n';
                });
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `PLI2050_RDS_Export_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`‚úÖ CSV exportado com sucesso!\n${pesquisas.length} pesquisas`);
                
            } catch (error) {
                alert(`‚ùå Erro ao exportar: ${error.message}`);
            }
        }

        // Inicializar ao carregar
        window.addEventListener('load', () => {
            // Aguardar core-api carregar
            setTimeout(() => {
                if (window.CoreAPI) {
                    document.getElementById('api-url').textContent = window.CoreAPI.BASE_URL;
                }
            }, 100);
        });
    </script>
    
    <!-- Script de Navega√ß√£o -->
    <script src="../js/spa-router.js?v=20251108"></script>
    <script src="../js/navbar.js?v=20251108"></script>
    <script src="../js/auth-simple.js?v=20251108"></script>
</body>
</html>
