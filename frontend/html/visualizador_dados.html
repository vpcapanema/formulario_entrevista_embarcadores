<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>PLI 2050 - Visualizador de Dados</title>
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
    <link rel="stylesheet" href="../css/index.css?v=20251107">
    <link rel="stylesheet" href="../css/pages.css?v=20251107">
    <link rel="stylesheet" href="../css/visualizador.css?v=20251109">
</head>
<body>
    <!-- NavegaÃ§Ã£o -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>PLI 2050 - SP</h1>
                <p>Plano de LogÃ­stica e Investimentos</p>
            </div>
            <div class="nav-menu">
                <button class="nav-btn" onclick="navegarPara('formulario')">
                    <span>ï¿½</span> FormulÃ¡rio
                </button>
                <button class="nav-btn" onclick="navegarPara('respostas')">
                    <span>ğŸ“Š</span> Respostas
                </button>
                <button class="nav-btn" onclick="navegarPara('analytics')">
                    <span>ğŸ“ˆ</span> Analytics
                </button>
                <button class="nav-btn" onclick="navegarPara('instrucoes')">
                    <span>ğŸ“–</span> InstruÃ§Ãµes
                </button>
                <button class="nav-btn active" onclick="navegarPara('visualizador')">
                    <span>ï¿½ğŸ”</span> Visualizador
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>ğŸ” Visualizador de Dados - AWS RDS</h2>
            <p>Visualize os dados armazenados no banco PostgreSQL (AWS RDS)</p>
        </div>
    
    <div class="info-box">
        <h2>ğŸ“Š InformaÃ§Ãµes do Banco de Dados</h2>
        <div class="status info">
            <strong>ğŸ—„ï¸ Banco:</strong> PostgreSQL 17<br>
            <strong>â˜ï¸ Hospedagem:</strong> AWS RDS (us-east-1)<br>
            <strong>ğŸ“¦ Database:</strong> sigma_pli<br>
            <strong>ğŸ” Schema:</strong> formulario_embarcadores<br>
            <strong>ğŸ“‹ View Principal:</strong> v_pesquisas_completa (65 campos)<br>
            <strong>ğŸŒ API:</strong> <span id="api-url"></span>
        </div>
    </div>

    <div class="info-box">
        <h2>ğŸ’¾ Dados da View v_pesquisas_completa</h2>
        <button onclick="loadDataFromRDS()">ğŸ”„ Carregar Dados do RDS</button>
        <button onclick="showRawDataRDS()">ğŸ“„ Ver JSON Completo</button>
        <button onclick="exportToCSV()">ğŸ“¥ Exportar CSV</button>
        <div id="loading-status" class="loading-status">
            <strong>â³ Carregando dados do RDS...</strong>
        </div>
        <div id="data-container"></div>
    </div>

    <div class="info-box">
        <h2>ğŸ› ï¸ Ferramentas de Desenvolvedor</h2>
        <div class="warning">
            <strong>ğŸ’¡ Dica:</strong> Para ver as requisiÃ§Ãµes de rede:<br>
            1. Pressione <kbd>F12</kbd> para abrir DevTools<br>
            2. VÃ¡ na aba <strong>"Network"</strong><br>
            3. Clique em <strong>"Carregar Dados do RDS"</strong><br>
            4. Veja a requisiÃ§Ã£o para <code>/api/pesquisas/listar</code>
        </div>
    </div>
    
    </div> <!-- Fecha container -->

    <script>
        // Carregar core-api para fazer requisiÃ§Ãµes
        const script = document.createElement('script');
        script.src = '../js/core-api.js?v=20251109';
        document.head.appendChild(script);

        // Mostrar URL da API
        script.onload = function() {
            document.getElementById('api-url').textContent = window.CoreAPI.BASE_URL;
        };

        // Carregar dados do RDS via API
        async function loadDataFromRDS() {
            const container = document.getElementById('data-container');
            const loadingStatus = document.getElementById('loading-status');
            
            try {
                loadingStatus.classList.add('show');
                container.innerHTML = '';
                
                console.log('ğŸ“¡ Buscando dados do RDS...');
                const response = await window.CoreAPI.get('/api/pesquisas/listar?limit=1000');
                
                loadingStatus.classList.remove('show');
                
                if (!response.pesquisas || response.pesquisas.length === 0) {
                    container.innerHTML = `
                        <div class="status info">
                            ğŸ“­ Nenhuma pesquisa encontrada no banco RDS.<br>
                            VÃ¡ para a pÃ¡gina de FormulÃ¡rio e envie uma pesquisa!
                        </div>
                    `;
                    return;
                }
                
                const pesquisas = response.pesquisas;
                
                let html = `
                    <div class="status success">
                        âœ… <strong>${pesquisas.length}</strong> pesquisa(s) encontrada(s) no RDS!
                    </div>
                    <h3>Resumo das Pesquisas:</h3>
                `;
                
                pesquisas.forEach((p, i) => {
                    html += `
                        <div class="pesquisa-card">
                            <strong>Pesquisa ${i + 1}:</strong><br>
                            <strong>ID:</strong> ${p.id_pesquisa}<br>
                            <strong>Empresa:</strong> ${p.razao_social || p.nome_empresa}<br>
                            <strong>CNPJ:</strong> ${p.cnpj || 'N/A'}<br>
                            <strong>Entrevistado:</strong> ${p.nome_entrevistado}<br>
                            <strong>FunÃ§Ã£o:</strong> ${p.funcao_entrevistado}<br>
                            <strong>Data:</strong> ${p.data_entrevista || 'N/A'}<br>
                            <strong>Produto Principal:</strong> ${p.produto_principal}<br>
                            <strong>Tipo Transporte:</strong> ${p.tipo_transporte}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                console.log('âœ… Dados carregados:', pesquisas.length);
                
            } catch (error) {
                loadingStatus.classList.remove('show');
                console.error('âŒ Erro ao carregar dados:', error);
                container.innerHTML = `
                    <div class="status warning">
                        âŒ Erro ao conectar ao RDS:<br>
                        <strong>Mensagem:</strong> ${error.message || 'Erro desconhecido'}<br><br>
                        <strong>PossÃ­veis causas:</strong><br>
                        â€¢ Backend nÃ£o estÃ¡ rodando no Render<br>
                        â€¢ Problema de conexÃ£o com AWS RDS<br>
                        â€¢ CORS bloqueando requisiÃ§Ã£o<br><br>
                        <strong>URL da API:</strong> ${window.CoreAPI?.BASE_URL || 'N/A'}
                    </div>
                `;
            }
        }

        // Mostrar JSON completo
        async function showRawDataRDS() {
            const container = document.getElementById('data-container');
            const loadingStatus = document.getElementById('loading-status');
            
            try {
                loadingStatus.classList.add('show');
                const response = await window.CoreAPI.get('/api/pesquisas/listar?limit=1000');
                loadingStatus.classList.remove('show');
                
                const json = JSON.stringify(response, null, 2);
                
                container.innerHTML = `
                    <h3>JSON Completo (View v_pesquisas_completa):</h3>
                    <div class="data-viewer">${json}</div>
                `;
                
            } catch (error) {
                loadingStatus.classList.remove('show');
                container.innerHTML = `<div class="status warning">âŒ Erro: ${error.message}</div>`;
            }
        }

        // Exportar para CSV
        async function exportToCSV() {
            try {
                const response = await window.CoreAPI.get('/api/pesquisas/listar?limit=1000');
                
                if (!response.pesquisas || response.pesquisas.length === 0) {
                    alert('ğŸ“­ Nenhuma pesquisa para exportar');
                    return;
                }
                
                const pesquisas = response.pesquisas;
                const headers = Object.keys(pesquisas[0]);
                
                // Criar CSV
                let csv = headers.join(',') + '\n';
                
                pesquisas.forEach(p => {
                    const row = headers.map(header => {
                        let value = p[header];
                        // Escapar vÃ­rgulas e aspas
                        if (value && typeof value === 'string') {
                            value = value.replace(/"/g, '""');
                            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                                value = `"${value}"`;
                            }
                        }
                        return value || '';
                    });
                    csv += row.join(',') + '\n';
                });
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `PLI2050_RDS_Export_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`âœ… CSV exportado com sucesso!\n${pesquisas.length} pesquisas`);
                
            } catch (error) {
                alert(`âŒ Erro ao exportar: ${error.message}`);
            }
        }

        // Inicializar ao carregar
        window.addEventListener('load', () => {
            // Aguardar core-api carregar
            setTimeout(() => {
                if (window.CoreAPI) {
                    document.getElementById('api-url').textContent = window.CoreAPI.BASE_URL;
                }
            }, 100);
        });
    </script>
    
    <!-- Script de NavegaÃ§Ã£o -->
    <script src="../js/spa-router.js?v=20251108"></script>
    <script src="../js/navbar.js?v=20251108"></script>
    <script src="../js/auth-simple.js?v=20251108"></script>
</body>
</html>
