<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLI 2050 - Visualizador de Dados</title>
    <link rel="stylesheet" href="/css/index.css?v=20251107">
    <link rel="stylesheet" href="/css/pages.css?v=20251107">
    <style>
        .visualizador-container {
            margin: 2rem auto;
            max-width: 1400px;
        }

        .controles-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .controles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .control-group select,
        .control-group input {
            padding: 0.7rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .actions-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .btn-visualizar {
            background: var(--secondary-color);
            color: white;
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-visualizar:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .resultado-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-height: 400px;
        }

        .loading-state {
            text-align: center;
            padding: 4rem;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--secondary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .dados-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .dado-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
        }

        .dado-card .label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .dado-card .value {
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .tabela-pesquisas {
            overflow-x: auto;
            margin-top: 2rem;
        }

        .tabela-pesquisas table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .tabela-pesquisas thead {
            background: var(--primary-color);
            color: white;
        }

        .tabela-pesquisas th,
        .tabela-pesquisas td {
            padding: 0.8rem;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        .tabela-pesquisas tbody tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .kpi-mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .kpi-mini-card {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .kpi-mini-card .number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .kpi-mini-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>PLI 2050 - SP</h1>
                <p>Plano de Log√≠stica e Investimentos</p>
            </div>
            <div class="nav-menu">
                <button class="nav-btn" onclick="navegarPara('formulario')">
                    <span>üìã</span> Formul√°rio
                </button>
                <button class="nav-btn" onclick="navegarPara('respostas')">
                    <span>üìä</span> Respostas
                </button>
                <button class="nav-btn" onclick="navegarPara('analytics')">
                    <span>üìà</span> Analytics
                </button>
                <button class="nav-btn" onclick="navegarPara('instrucoes')">
                    <span>üìñ</span> Instru√ß√µes
                </button>
                <button class="nav-btn active" onclick="navegarPara('visualizador')">
                    <span>üîç</span> Visualizador
                </button>
            </div>
        </div>
    </nav>

    <div class="container visualizador-container">
        <div class="page-header">
            <h2>üîç Visualizador de Dados do Banco PostgreSQL</h2>
            <p>Consulte e visualize dados em tempo real da view v_pesquisas_completa</p>
        </div>

        <!-- Controles de Filtro -->
        <div class="controles-section">
            <h3>üéØ Filtros de Consulta</h3>
            <div class="controles-grid">
                <div class="control-group">
                    <label for="filtro-empresa">üè¢ Empresa</label>
                    <select id="filtro-empresa">
                        <option value="">Todas as empresas</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="filtro-produto">üì¶ Produto</label>
                    <select id="filtro-produto">
                        <option value="">Todos os produtos</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="filtro-estado">üìç Estado Origem</label>
                    <select id="filtro-estado">
                        <option value="">Todos os estados</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="filtro-tipo">üöö Tipo de Transporte</label>
                    <select id="filtro-tipo">
                        <option value="">Todos os tipos</option>
                        <option value="importacao">Importa√ß√£o</option>
                        <option value="exportacao">Exporta√ß√£o</option>
                        <option value="local">Local</option>
                    </select>
                </div>
            </div>

            <div class="actions-row">
                <button class="btn-visualizar" onclick="carregarDados()">
                    üîç Visualizar Dados
                </button>
                <button class="btn-visualizar btn-muted" onclick="limparFiltros()">
                    üîÑ Limpar Filtros
                </button>
            </div>
        </div>

        <!-- KPIs R√°pidos -->
        <div class="kpi-mini-grid hidden" id="kpis-container">
            <!-- Preenchido via JS -->
        </div>

        <!-- Resultado -->
        <div class="resultado-section" id="resultado">
            <div class="empty-state">
                <h3>üëÜ Selecione os filtros acima</h3>
                <p>Clique em "Visualizar Dados" para consultar o banco PostgreSQL</p>
            </div>
        </div>
    </div>

    <script src="/js/navbar.js?v=20251107"></script>
    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8000' : '';
        let dadosOriginais = [];
        let filtrosPopulados = false;

        // Inicializar ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîç Visualizador inicializado');
            popularFiltros();
        });

        /**
         * Popula dropdowns de filtros
         */
        async function popularFiltros() {
            if (filtrosPopulados) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/pesquisas/listar`);
                const data = await response.json();

                if (!data.success || !data.data) {
                    throw new Error('Formato inv√°lido');
                }

                dadosOriginais = data.data;

                // Popular empresa
                const empresas = [...new Set(dadosOriginais.map(d => d.nome_empresa))].sort();
                const selectEmpresa = document.getElementById('filtro-empresa');
                empresas.forEach(empresa => {
                    const option = document.createElement('option');
                    option.value = empresa;
                    option.textContent = empresa;
                    selectEmpresa.appendChild(option);
                });

                // Popular produto
                const produtos = [...new Set(dadosOriginais.map(d => d.produto_principal))].sort();
                const selectProduto = document.getElementById('filtro-produto');
                produtos.forEach(produto => {
                    const option = document.createElement('option');
                    option.value = produto;
                    option.textContent = produto;
                    selectProduto.appendChild(option);
                });

                // Popular estado
                const estados = [...new Set(dadosOriginais.map(d => d.origem_estado).filter(e => e))].sort();
                const selectEstado = document.getElementById('filtro-estado');
                estados.forEach(estado => {
                    const option = document.createElement('option');
                    option.value = estado;
                    option.textContent = estado;
                    selectEstado.appendChild(option);
                });

                filtrosPopulados = true;
                console.log('‚úÖ Filtros populados');

            } catch (error) {
                console.error('‚ùå Erro ao popular filtros:', error);
            }
        }

        /**
         * Carrega dados com filtros aplicados
         */
        async function carregarDados() {
            const resultado = document.getElementById('resultado');
            const kpisContainer = document.getElementById('kpis-container');

            // Loading
            resultado.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Consultando banco PostgreSQL...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/api/pesquisas/listar`);
                const data = await response.json();

                if (!data.success || !data.data) {
                    throw new Error('Erro ao carregar dados');
                }

                let pesquisas = data.data;

                // Aplicar filtros
                const empresa = document.getElementById('filtro-empresa').value;
                const produto = document.getElementById('filtro-produto').value;
                const estado = document.getElementById('filtro-estado').value;
                const tipo = document.getElementById('filtro-tipo').value;

                if (empresa) {
                    pesquisas = pesquisas.filter(p => p.nome_empresa === empresa);
                }
                if (produto) {
                    pesquisas = pesquisas.filter(p => p.produto_principal === produto);
                }
                if (estado) {
                    pesquisas = pesquisas.filter(p => p.origem_estado === estado);
                }
                if (tipo) {
                    pesquisas = pesquisas.filter(p => p.tipo_transporte === tipo);
                }

                if (pesquisas.length === 0) {
                    resultado.innerHTML = `
                        <div class="empty-state">
                            <h3>üîç Nenhum resultado encontrado</h3>
                            <p>Tente ajustar os filtros</p>
                        </div>
                    `;
                    kpisContainer.style.display = 'none';
                    return;
                }

                // Exibir KPIs
                exibirKPIs(pesquisas, kpisContainer);

                // Exibir tabela
                exibirTabela(pesquisas, resultado);

                console.log(`‚úÖ ${pesquisas.length} pesquisas carregadas`);

            } catch (error) {
                console.error('‚ùå Erro:', error);
                resultado.innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Erro ao carregar dados</h3>
                        <p>${error.message}</p>
                        <p>Verifique se o backend est√° rodando (porta 8000)</p>
                    </div>
                `;
                kpisContainer.style.display = 'none';
            }
        }

        /**
         * Exibe KPIs mini
         */
        function exibirKPIs(pesquisas, container) {
            const total = pesquisas.length;
            const empresasUnicas = new Set(pesquisas.map(p => p.nome_empresa)).size;
            const produtosUnicos = new Set(pesquisas.map(p => p.produto_principal)).size;
            
            const distancias = pesquisas.map(p => parseFloat(p.distancia) || 0).filter(d => d > 0);
            const distanciaMedia = distancias.length > 0 
                ? (distancias.reduce((a, b) => a + b, 0) / distancias.length).toFixed(1)
                : '0';

            container.style.display = 'grid';
            container.innerHTML = `
                <div class="kpi-mini-card">
                    <div class="number">${total}</div>
                    <div class="label">Pesquisas Filtradas</div>
                </div>
                <div class="kpi-mini-card">
                    <div class="number">${empresasUnicas}</div>
                    <div class="label">Empresas</div>
                </div>
                <div class="kpi-mini-card">
                    <div class="number">${produtosUnicos}</div>
                    <div class="label">Produtos</div>
                </div>
                <div class="kpi-mini-card">
                    <div class="number">${distanciaMedia} km</div>
                    <div class="label">Dist√¢ncia M√©dia</div>
                </div>
            `;
        }

        /**
         * Exibe tabela de resultados
         */
        function exibirTabela(pesquisas, container) {
            let html = `
                <h3>üìä Resultados (${pesquisas.length} pesquisas)</h3>
                <div class="tabela-pesquisas">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Empresa</th>
                                <th>Produto</th>
                                <th>Origem</th>
                                <th>Destino</th>
                                <th>Dist√¢ncia (km)</th>
                                <th>Modais</th>
                                <th>Tipo Transporte</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            pesquisas.forEach(p => {
                html += `
                    <tr>
                        <td><strong>${p.id_pesquisa}</strong></td>
                        <td>${p.nome_empresa || '-'}</td>
                        <td><span class="badge badge-info">${p.produto_principal || '-'}</span></td>
                        <td>${p.origem_municipio || '-'} / ${p.origem_estado || '-'}</td>
                        <td>${p.destino_municipio || '-'} / ${p.destino_estado || '-'}</td>
                        <td>${p.distancia ? parseFloat(p.distancia).toFixed(1) : '-'}</td>
                        <td>${Array.isArray(p.modais) ? p.modais.join(', ') : p.modais || '-'}</td>
                        <td>${p.tipo_transporte || '-'}</td>
                        <td><span class="badge badge-success">${p.status_pesquisa || 'finalizada'}</span></td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        /**
         * Limpa filtros
         */
        function limparFiltros() {
            document.getElementById('filtro-empresa').value = '';
            document.getElementById('filtro-produto').value = '';
            document.getElementById('filtro-estado').value = '';
            document.getElementById('filtro-tipo').value = '';

            const resultado = document.getElementById('resultado');
            resultado.innerHTML = `
                <div class="empty-state">
                    <h3>üëÜ Filtros limpos</h3>
                    <p>Clique em "Visualizar Dados" para ver todos os registros</p>
                </div>
            `;

            document.getElementById('kpis-container').style.display = 'none';
        }
    </script>
</body>
</html>
